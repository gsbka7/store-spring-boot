<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="renderer" content="webkit" />
	<title>購物車 | 文具專賣</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- Jquery -->
	<script src="https://code.jquery.com/jquery-3.6.4.js"></script>
	<!-- bootstrap -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
		crossorigin="anonymous"></script>
	<!-- fontawesome -->
	<script defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"
		integrity="sha384-rOA1PnstxnOBLzCLMcre8ybwbTmemjzdNlILg8O7z1lUkLXozs4DHonlDtnE7fpc"
		crossorigin="anonymous"></script>
	<script defer src="https://use.fontawesome.com/releases/v5.15.4/js/solid.js"
		integrity="sha384-/BxOvRagtVDn9dJ+JGCtcofNXgQO/CCCVKdMfL115s3gOgQxWaX/tSq5V8dRgsbc"
		crossorigin="anonymous"></script>
	<!-- 自定義CSS -->
	<link rel="stylesheet" href="../css/template.css">
	<link rel="stylesheet" href="../css/cart.css">
</head>

<body>
	<header class="header mb-5">
	<ul class="nav">
		<div>
			<a href="/"><img src="../images/index/logo.png" alt="" class="logo"></a>
		</div>
		<div class="item">
			<!-- <li class="nav-item">
                <a class="nav-link" href="">首頁</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/">商品一覽</a>
            </li> -->
			<li class="nav-item">
				<a href="orderInfo.html">
					<i class="fas fa-receipt"></i>
					<span class="orderinfo_title"></span>
				</a>
			</li>
			<li class="nav-item">
				<a href="cart.html">
					<i class="fas fa-shopping-cart"></i>
					<span class="cart_title"></span>
				</a>
			</li>
			<li id="login" class="nav-item">
				<a href="login.html">
					<i class="far fa-user fa-lg"></i>
					<span class="login_title"></span>
				</a>
			</li>
			<li id="logout" class="nav-item logout" style="display: none">
				<div>
					<i class="far fa-user fa-lg"></i>
					<span class="logout_title"></span>
				</div>
			</li>
		</div>
	</ul>
</header>
	<main>
		<section>
			<div class="container">
				<p class="title mb-5">購物車</p>
				<div class="return_to_index mb-5">
					<a href="/">〈</a>
				</div>
				<div id="noItem"></div>
				<div id="cart_form" class="cart_form">
					<form id="form_cart" action="orderConfirm.html" role="form">
						<table class="cart-table" width="100%">
							<thead>
								<tr>
									<th width="8%">
										<input id="checkAllBtn" type="checkbox" class="ckall" style="width:20px;height:20px;" checked/>全選
									</th>
									<th width="110"></th>
									<th width="29%">商品</th>
									<th width="11%">單價</th>
									<th width="15%">數量</th>
									<th width="11%">金額</th>
									<th></th>
								</tr>
							</thead>
							<tbody id="cart-list" class="cart-body">
								<tr>
									<td>
										<input type="checkbox" class="ckitem" />
									</td>
									<td><img src="../images/product/correctiontape/1_big.jpg" class="img-responsive" />
									</td>
									<td>修正帶 6m 四色</td>
									<td>$<span id="goodsPrice1">110</span></td>
									<td>
										<input type="button" value="-" class="num-btn" onclick="reduceNum(1)" />
										<input id="goodsCount1" type="text" size="2" readonly="readonly"
											class="num-text" value="1">
										<input class="num-btn" type="button" value="+" onclick="addNum(1)" />
									</td>
									<td><span id="goodsCast1"></span></td>
									<td>
										<input type="button" onclick="deleteCartItem(this)"
											class="cart-del btn btn-default btn-xs" value="删除" />
									</td>
								</tr>
								<tr>
									<td>
										<input type="checkbox" class="ckitem" />
									</td>
									<td><img src="../images/product/correctiontape/1_big.jpg" class="img-responsive" />
									</td>
									<td>修正帶 6m 四色</td>
									<td>$<span id="goodsPrice1">110</span></td>
									<td>
										<input type="button" value="-" class="num-btn" onclick="reduceNum(1)" />
										<input id="goodsCount1" type="text" size="2" readonly="readonly"
											class="num-text" value="1">
										<input class="num-btn" type="button" value="+" onclick="addNum(1)" />
									</td>
									<td><span id="goodsCast1"></span></td>
									<td>
										<input type="button" onclick="delCartItem(this)"
											class="cart-del btn btn-default btn-xs" value="删除" />
									</td>
								</tr>
							</tbody>
						</table>
						<div class="total-bar mb-5">
							<div class="row">
								<!-- <div class="col-6">
										<span id="selectTotal" class="total_price_1">總金額：$<span class="total_price_2">570</span></span>
									</div> -->
								<div class="col-12">
									<input type="submit" value="確認訂單" id="checkout_btn" class="checkout_btn" />
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
		</section>
	</main>

	<footer class="footer">
		<span>@個人練習作品 無任何商業用途</span>
	</footer>

	<!-- 自定義JS -->
	<script src="../js/getSession.js"></script>

	<script type="text/javascript">
		$(document).ready(function () {
			showCartList();
		})

		// 展示購物車列表
		function showCartList() {
			// 清空tboby標籤中的資料
			$("#cart-list").empty();
			$.ajax({
				url: "/carts",
				type: "POST",
				dataType: "JSON",
				success: function (json) {
					let list = json.data;
					if(list.length > 0){
						for (let i = 0; i < list.length; i++) {
							let tr = `<tr>
										<td>
											<input name="cids" value="#{cid}" type="checkbox" id="ckitem" class="ckitem" style="width:20px;height:20px;" checked/>
										</td>
										<td><img src="..#{image}1_big.jpg" class="img-responsive" /></td>
										<td>#{title}</td>
										<td>$<span id="goodsPrice#{cid}">#{price}</span></td>
										<td>
											<input id="price-#{cid}" type="button" value="-" class="num-btn" onclick="minusNum(#{cid})"/>
											<input id="goodsCount#{cid}" type="text" size="2" readonly="readonly" class="num-text" value="#{num}">
											<input id="price+#{cid}" class="num-btn" type="button" value="+" onclick="addNum(#{cid})" />
										</td>
										<td>$<span id="goodsCast#{cid}">#{totalPrice-s}</span></td>
										<td>
											<input type="button" id="delbtn#{cid}" onclick="deleteCartItem(#{cid})" class="cart-del btn btn-default btn-xs" value="删除"/>
										</td>
									</tr>`
							tr = tr.replace(/#{cid}/g, list[i].cid)
							tr = tr.replace(/#{image}/g, list[i].image)
							tr = tr.replace(/#{title}/g, list[i].title)
							tr = tr.replace(/#{price}/g, list[i].price)
							tr = tr.replace(/#{num}/g, list[i].num)
							tr = tr.replace(/#{totalPrice-s}/g, list[i].price * list[i].num)
							$("#cart-list").append(tr);

							$(function() {
								$("#checkAllBtn").click(function () {
									if ($("#checkAllBtn").prop("checked")) {
										$("input[name='cids']").prop("checked", true);
									} else {
										$("input[name='cids']").prop("checked", false);
									}
								})
							})

							$("#checkAllBtn").click(function (){
								$("#cart-list input[name='cids']").prop("checked",this.checked)
							})

							$('#cart-list').on('change', function () {
								console.log($('#cart-list').length + "    cart-list")
								console.log($('#cart-list:checked').length + "    checked");
								if ($('#cart-list').length==$("#cart-list:checked").length) {
									$('#checkAllBtn').prop('checked', true)
								} else {
									$('#checkAllBtn').prop('checked', false)
								}
							})
						}
					}else{
						$("#cart_form").empty();
						let tr = '<span>購物車沒有商品</span>'
						$("#noItem").append(tr);
					}
				},
				error: function (xhr) {
					alert("購物車列表資料載入產生未知的異常，" + xhr.message)
				}
			})
		}

		
		function addNum(cid) {
			$.ajax({
				url: "/carts/" + cid + "/num/add",
				type: "POST",
				dataType: "JSON",
				success: function (json) {
					if (json.state == 200) {
						$("#goodsCount" + cid).val(json.data);
						let price = $("#goodsPrice" + cid).html();
						let totalPrice = price * json.data;
						$("#goodsCast" + cid).html(totalPrice);
					} else {
						alert("商品數量增加失敗" + json.message);
					}
				},
				error: function (xhr) {
					alert("商品數量增加產生未知的異常，" + xhr.message)
				}
			})
		}

		function minusNum(cid) {
			$.ajax({
				url: "/carts/" + cid + "/num/minus",
				type: "POST",
				dataType: "JSON",
				success: function (json) {
					if (json.state == 200) {
						$("#goodsCount" + cid).val(json.data);
						let price = $("#goodsPrice" + cid).html();
						let totalPrice = price * json.data;
						$("#goodsCast" + cid).html(totalPrice);
					} else {
						alert("商品數量減少失敗" + json.message);
					}
				},
				error: function (xhr) {
					alert("商品數量減少產生未知的異常，" + xhr.message)
				}
			})
		}

		function deleteCartItem(cid) {
			$.ajax({
				url: "/carts/delete/" + cid,
				type: "POST",
				success: function (json) {
					if (json.state == 200) {
						$('#delbtn'+cid).parents("tr").remove();
						location.reload();
						alert("商品刪除成功")
					}
				},
				error: function (xhr) {
					alert("商品刪除產生未知的異常，" + xhr.message)
				}
			})
		}
	</script>
</body>
</html>